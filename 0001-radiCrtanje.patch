From c84ef4af57e9822df3f374c4d320ebbaf8578aff Mon Sep 17 00:00:00 2001
From: Bekica <komnenic.andjela@gmail.com>
Date: Tue, 5 Dec 2023 19:59:13 +0100
Subject: [PATCH] radiCrtanje

---
 .../implementation/Diagram.java               |  3 +-
 .../sidebar/NewInterClassAction.java          |  1 +
 .../src/main/java/raf/dsw/novo/Klasa.java     |  2 +-
 .../java/raf/dsw/paint/InterClassPainter.java |  2 +-
 .../java/raf/dsw/state/DodavanjeState.java    | 19 +++++++--
 .../src/main/java/raf/dsw/state/State.java    |  7 ++--
 .../dsw/tree/ClassyTreeImplementation.java    |  4 ++
 .../controller/MouseGraphicsEvent.java        | 10 ++++-
 .../raf/dsw/workspace/view/DiagramView.java   |  4 +-
 .../raf/dsw/workspace/view/PackageView.java   | 42 ++++++++++++++++---
 10 files changed, 76 insertions(+), 18 deletions(-)

diff --git a/ClassyCrafT/src/main/java/raf/dsw/classyrepository/implementation/Diagram.java b/ClassyCrafT/src/main/java/raf/dsw/classyrepository/implementation/Diagram.java
index 17bc9c6..f820e22 100644
--- a/ClassyCrafT/src/main/java/raf/dsw/classyrepository/implementation/Diagram.java
+++ b/ClassyCrafT/src/main/java/raf/dsw/classyrepository/implementation/Diagram.java
@@ -15,6 +15,7 @@ public class Diagram extends ClassyNodeComposite {
 
     @Override
     public void addChild(ClassyNode child) {
-
+        this.notifySubscriber("NEW");
+        this.notifySubscriber("REPAINT");
     }
 }
diff --git a/ClassyCrafT/src/main/java/raf/dsw/controller/sidebar/NewInterClassAction.java b/ClassyCrafT/src/main/java/raf/dsw/controller/sidebar/NewInterClassAction.java
index 53635a5..d1ad226 100644
--- a/ClassyCrafT/src/main/java/raf/dsw/controller/sidebar/NewInterClassAction.java
+++ b/ClassyCrafT/src/main/java/raf/dsw/controller/sidebar/NewInterClassAction.java
@@ -22,5 +22,6 @@ public class NewInterClassAction extends AbstractClassyAction {
     public void actionPerformed(ActionEvent e) {
         StateManager stateManager = ((WorkSpaceImplementation) MainFrame.getInstance().getWorkspace()).getPackageView().getStateManager();
         stateManager.setNewDodavanjeState();
+        System.out.println("lolololo");
     }
 }
diff --git a/ClassyCrafT/src/main/java/raf/dsw/novo/Klasa.java b/ClassyCrafT/src/main/java/raf/dsw/novo/Klasa.java
index f63876e..8fae2b0 100644
--- a/ClassyCrafT/src/main/java/raf/dsw/novo/Klasa.java
+++ b/ClassyCrafT/src/main/java/raf/dsw/novo/Klasa.java
@@ -3,7 +3,7 @@ package raf.dsw.novo;
 import raf.dsw.classyrepository.composite.ClassyNode;
 
 public class Klasa extends InterClass{
-    public Klasa(String name, ClassyNode parent, double x, double y) {
+    public Klasa(String name, ClassyNode parent, int x, int y) {
         super(name, parent, x, y);
     }
 }
diff --git a/ClassyCrafT/src/main/java/raf/dsw/paint/InterClassPainter.java b/ClassyCrafT/src/main/java/raf/dsw/paint/InterClassPainter.java
index 6bc268e..c084fe4 100644
--- a/ClassyCrafT/src/main/java/raf/dsw/paint/InterClassPainter.java
+++ b/ClassyCrafT/src/main/java/raf/dsw/paint/InterClassPainter.java
@@ -33,7 +33,7 @@ public class InterClassPainter extends ElementPainter{
         g2D.draw(getShape());
 
         double xString = newKlasa.getX() + ((double) (widthRectangle - fm.stringWidth(newKlasa.getName())) / 2);
-        double yString = newKlasa.getY() + ((double) (heightRectangle - fm.getHeight() / 2) + fm.getAscent());
+        double yString = newKlasa.getY() + ((double) (heightRectangle + fm.getAscent()) / 2);
         g2D.drawString(newKlasa.getName(), (float) xString, (float) yString);
     }
 
diff --git a/ClassyCrafT/src/main/java/raf/dsw/state/DodavanjeState.java b/ClassyCrafT/src/main/java/raf/dsw/state/DodavanjeState.java
index e927cc6..c985f0a 100644
--- a/ClassyCrafT/src/main/java/raf/dsw/state/DodavanjeState.java
+++ b/ClassyCrafT/src/main/java/raf/dsw/state/DodavanjeState.java
@@ -3,6 +3,8 @@ package raf.dsw.state;
 import raf.dsw.classyrepository.implementation.Diagram;
 import raf.dsw.core.ApplicationFramework;
 import raf.dsw.novo.Klasa;
+import raf.dsw.paint.ElementPainter;
+import raf.dsw.paint.InterClassPainter;
 import raf.dsw.workspace.view.DiagramView;
 import raf.dsw.workspace.view.PackageView;
 
@@ -12,7 +14,7 @@ import java.awt.*;
 //klase, interfejsa, enuma
 public class DodavanjeState implements State{
     @Override
-    public void misKliknut(int x, int y, Diagram currDiagram) {
+    public void misKliknut(int x, int y, DiagramView currDiagramView, PackageView pkg) {
         /*DiagramView currDiagramView = (DiagramView) currDiagram.getParent().getTabbedPane().getSelectedComponent();
 
         String topicString = JOptionPane.showInputDialog(new JFrame(), "Unesite pojam", "Pojam", JOptionPane.PLAIN_MESSAGE);*/
@@ -28,15 +30,26 @@ public class DodavanjeState implements State{
         thisTopicPainter = painter;
         projectView.addPainterForCurrent(painter);*/
         //Klasa newKlasa = new Klasa();
+        String nameString = JOptionPane.showInputDialog(new JFrame(), "Unesite pojam", "Pojam", JOptionPane.PLAIN_MESSAGE);
+        Klasa newKlasa = new Klasa(nameString, currDiagramView.getDiagram(),x, y);
+        currDiagramView.getDiagram().addChild(newKlasa);
+
+        ElementPainter elementPainter = new InterClassPainter(newKlasa);
+        //currDiagramView.getParent().addPainterForCurrent(elementPainter);
+
+        pkg.addPainterForCurrent(elementPainter);
+
+        System.out.println("da");
+
     }
 
     @Override
-    public void misOtpusten(Point e, PackageView packageView, Diagram currDiagram) {
+    public void misOtpusten(int x, int y, DiagramView currDiagram) {
 
     }
 
     @Override
-    public void misPrivucen(Point e, PackageView packageView, Diagram currDiagram) {
+    public void misPrivucen(int x, int y, DiagramView currDiagram) {
 
     }
 }
diff --git a/ClassyCrafT/src/main/java/raf/dsw/state/State.java b/ClassyCrafT/src/main/java/raf/dsw/state/State.java
index 07b41da..87be3c1 100644
--- a/ClassyCrafT/src/main/java/raf/dsw/state/State.java
+++ b/ClassyCrafT/src/main/java/raf/dsw/state/State.java
@@ -1,13 +1,14 @@
 package raf.dsw.state;
 
 import raf.dsw.classyrepository.implementation.Diagram;
+import raf.dsw.workspace.view.DiagramView;
 import raf.dsw.workspace.view.PackageView;
 
 import java.awt.*;
 
 public interface  State {
 
-     void misKliknut(int x, int y, Diagram currDiagram);
-     void misOtpusten(Point e, PackageView packageView, Diagram currDiagram);
-     void misPrivucen(Point e, PackageView packageView, Diagram currDiagram);
+     void misKliknut(int x, int y, DiagramView currDiagram, PackageView pkg);
+     void misOtpusten(int x, int y, DiagramView currDiagram);
+     void misPrivucen(int x, int y, DiagramView currDiagram);
 }
diff --git a/ClassyCrafT/src/main/java/raf/dsw/tree/ClassyTreeImplementation.java b/ClassyCrafT/src/main/java/raf/dsw/tree/ClassyTreeImplementation.java
index addd223..db15f1e 100644
--- a/ClassyCrafT/src/main/java/raf/dsw/tree/ClassyTreeImplementation.java
+++ b/ClassyCrafT/src/main/java/raf/dsw/tree/ClassyTreeImplementation.java
@@ -1,5 +1,6 @@
 package raf.dsw.tree;
 
+import raf.dsw.classyrepository.composite.ClassyNode;
 import raf.dsw.classyrepository.composite.ClassyNodeComposite;
 import raf.dsw.classyrepository.implementation.ProjectExplorer;
 import raf.dsw.classyrepository.factoryMethod.FactoryUtils;
@@ -7,9 +8,11 @@ import raf.dsw.classyrepository.factoryMethod.NodeFactory;
 import raf.dsw.classyrepository.factoryMethod.PackageFactory;
 import raf.dsw.tree.model.ClassyTreeItem;
 import raf.dsw.tree.view.ClassyTreeView;
+import raf.dsw.view.MainFrame;
 
 import javax.swing.*;
 import javax.swing.tree.DefaultTreeModel;
+import javax.swing.tree.TreePath;
 
 public class ClassyTreeImplementation implements ClassyTree{
     private ClassyTreeView treeView;
@@ -66,4 +69,5 @@ public class ClassyTreeImplementation implements ClassyTree{
         update();
     }
 
+
 }
diff --git a/ClassyCrafT/src/main/java/raf/dsw/workspace/controller/MouseGraphicsEvent.java b/ClassyCrafT/src/main/java/raf/dsw/workspace/controller/MouseGraphicsEvent.java
index 933167f..fcbd0e7 100644
--- a/ClassyCrafT/src/main/java/raf/dsw/workspace/controller/MouseGraphicsEvent.java
+++ b/ClassyCrafT/src/main/java/raf/dsw/workspace/controller/MouseGraphicsEvent.java
@@ -17,6 +17,12 @@ import java.awt.geom.Point2D;
 
 public class MouseGraphicsEvent implements MouseListener, MouseMotionListener, MouseInputListener {
 
+    private DiagramView currDiagramView;
+
+    public MouseGraphicsEvent(DiagramView currDiagramView) {
+        this.currDiagramView = currDiagramView;
+    }
+
     @Override
     public void mouseClicked(MouseEvent e) {
 
@@ -29,8 +35,8 @@ public class MouseGraphicsEvent implements MouseListener, MouseMotionListener, M
         Point worldP = getWorldCoordinates(e);*/
 
         PackageView packageView = ((WorkSpaceImplementation) MainFrame.getInstance().getWorkspace()).getPackageView();
-        Diagram currDiagram = ((DiagramView) packageView.getTabbedPane().getSelectedComponent()).getDiagram();
-        packageView.startMisKliknut(e.getX(), e.getY(), currDiagram);
+        DiagramView currDiagramView = ((DiagramView) packageView.getTabbedPane().getSelectedComponent());
+        packageView.getStateManager().getCurrState().misKliknut(e.getX(), e.getY(), currDiagramView, packageView);
     }
 
     @Override
diff --git a/ClassyCrafT/src/main/java/raf/dsw/workspace/view/DiagramView.java b/ClassyCrafT/src/main/java/raf/dsw/workspace/view/DiagramView.java
index eef451f..4b691dd 100644
--- a/ClassyCrafT/src/main/java/raf/dsw/workspace/view/DiagramView.java
+++ b/ClassyCrafT/src/main/java/raf/dsw/workspace/view/DiagramView.java
@@ -29,8 +29,8 @@ public class DiagramView extends JPanel implements ISubscriber {
 
     public DiagramView(Diagram diagram){
         this.diagram = diagram;
-        this.addMouseListener(new MouseGraphicsEvent());
-        this.addMouseMotionListener(new MouseGraphicsEvent());
+        this.addMouseListener(new MouseGraphicsEvent(this));
+        this.addMouseMotionListener(new MouseGraphicsEvent(this));
     }
 
     @Override
diff --git a/ClassyCrafT/src/main/java/raf/dsw/workspace/view/PackageView.java b/ClassyCrafT/src/main/java/raf/dsw/workspace/view/PackageView.java
index 1844ba8..5085eae 100644
--- a/ClassyCrafT/src/main/java/raf/dsw/workspace/view/PackageView.java
+++ b/ClassyCrafT/src/main/java/raf/dsw/workspace/view/PackageView.java
@@ -8,12 +8,17 @@ import raf.dsw.classyrepository.composite.ClassyNode;
 import raf.dsw.classyrepository.composite.ClassyNodeComposite;
 import raf.dsw.classyrepository.implementation.Project;
 import raf.dsw.observer.ISubscriber;
+import raf.dsw.paint.ElementPainter;
 import raf.dsw.state.StateManager;
+import raf.dsw.tree.ClassyTreeImplementation;
+import raf.dsw.view.MainFrame;
 
 import javax.swing.*;
 import java.awt.*;
 import java.util.ArrayList;
+import java.util.HashMap;
 import java.util.List;
+import java.util.Map;
 
 @Getter
 @Setter
@@ -28,8 +33,8 @@ public class PackageView extends JPanel implements ISubscriber{
     private JTabbedPane tabbedPane = new JTabbedPane();
     private List<DiagramView> tabs = new ArrayList<>();
 
-    /*Map<Diagram, List<ElementPainter>> paintersForMap = new HashMap<>();
-    List<ElementPainter> selectedComponents = new ArrayList<>();*/
+    Map<Diagram, List<ElementPainter>> paintersForDiagram = new HashMap<>();
+    List<ElementPainter> selectedComponents = new ArrayList<>();
     private StateManager stateManager;
 
     public PackageView() {
@@ -69,6 +74,8 @@ public class PackageView extends JPanel implements ISubscriber{
                 DiagramView tab = new DiagramView((Diagram) child);
                 child.addSubscriber(tab);
                 tabs.add(tab);
+
+                paintersForDiagram.putIfAbsent((Diagram) child, new ArrayList<>());
             }
 
         }
@@ -94,6 +101,7 @@ public class PackageView extends JPanel implements ISubscriber{
                 if (child instanceof Diagram) {
                     DiagramView tab = new DiagramView((Diagram) child);
                     child.addSubscriber(tab);
+                    paintersForDiagram.putIfAbsent((Diagram) child, new ArrayList<>());
 
                     if (!tabs.contains(tab)) {
                         tabs.add(tab);
@@ -120,16 +128,40 @@ public class PackageView extends JPanel implements ISubscriber{
             getTabbedPane().removeAll();
 
         }
+        else if(notification.equals("REPAINT")) {
+            DiagramView currDiagramView = tabs.get(tabbedPane.getSelectedIndex());
+            currDiagramView.setPainters(paintersForDiagram.get(currDiagramView.getDiagram()));
+        }
+        this.revalidate();
+        this.repaint();
 
     }
 
+
+    @Override
+    protected void paintComponent(Graphics g) {
+        super.paintComponent(g);
+        if(tabbedPane == null || tabs == null || tabs.isEmpty()) return;
+        DiagramView currDiagramView = (DiagramView) tabbedPane.getSelectedComponent();
+        currDiagramView.setPainters(paintersForDiagram.get(currDiagramView.getDiagram()));
+        currDiagramView.revalidate();
+        currDiagramView.repaint();
+    }
+
     //samo ga zove ovde
     public void startMisKliknut(int x, int y, Diagram currDiagram){
-        this.stateManager.setNewDodavanjeState();
+        this.startDodavanjeState();
     }
 
+    public void startDodavanjeState(){
+        this.stateManager.setNewDodavanjeState();
+    }
 
-    void startState(){
-        //stateManager.getCurrState().misKliknut();
+    public void addPainterForCurrent(ElementPainter painter){
+        Diagram currDiagram = ((DiagramView)tabbedPane.getSelectedComponent()).getDiagram();
+        paintersForDiagram.get(currDiagram).add(painter);
+        currDiagram.addChild(painter.getDgElement());
+        //dodati u stablo
+        repaint();
     }
 }
-- 
2.42.0.windows.2

